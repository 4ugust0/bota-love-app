rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // üîß FUN√á√ïES AUXILIARES
    // ============================================
    
    // Verifica se usu√°rio est√° autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verifica se √© o pr√≥prio usu√°rio
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Verifica se usu√°rio √© participante
    function isParticipant(participants) {
      return isAuthenticated() && request.auth.uid in participants;
    }
    
    // Verifica se usu√°rio est√° no array users
    function isUserInArray(users) {
      return isAuthenticated() && request.auth.uid in users;
    }

    // Verifica se usu√°rio √© admin (existe na cole√ß√£o users_admin e est√° ativo)
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users_admin/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users_admin/$(request.auth.uid)).data.status == 'active';
    }

    // ============================================
    // üëë USERS_ADMIN (Administradores do Painel)
    // ============================================
    match /users_admin/{userId} {
      // Leitura: usu√°rio autenticado pode ler seu pr√≥prio documento
      // OU qualquer admin ativo pode ler outros admins
      allow read: if isAuthenticated() && 
        (request.auth.uid == userId || 
         (exists(/databases/$(database)/documents/users_admin/$(request.auth.uid)) &&
          get(/databases/$(database)/documents/users_admin/$(request.auth.uid)).data.status == 'active'));
      
      // Cria√ß√£o: apenas admins ativos podem criar novos admins
      allow create: if isAdmin();
      
      // Atualiza√ß√£o: admin pode atualizar a si mesmo ou outros admins
      allow update: if isAuthenticated() && 
        (request.auth.uid == userId || isAdmin());
      
      // Dele√ß√£o: apenas admins ativos
      allow delete: if isAdmin();
    }

    // ============================================
    // üîë RECOVERY_CODES (C√≥digos de recupera√ß√£o de senha)
    // ============================================
    match /recovery_codes/{codeId} {
      // Acesso apenas via Admin SDK (API routes)
      allow read, write: if false;
    }

    // ============================================
    // üë§ USERS (Usu√°rios do App Mobile)
    // ============================================
    match /users/{userId} {
      // Leitura: autenticado pode ver outros perfis
      // Admins podem ler todos os perfis
      allow read: if isAuthenticated();
      
      // Cria√ß√£o: apenas o pr√≥prio usu√°rio
      allow create: if isOwner(userId);
      
      // Atualiza√ß√£o: pr√≥prio usu√°rio OU admin pode atualizar (para modera√ß√£o)
      allow update: if isOwner(userId) || isAdmin();
      
      // Dele√ß√£o: apenas o pr√≥prio usu√°rio ou admin
      allow delete: if isOwner(userId) || isAdmin();
      
      // Subcollection: profile_views
      match /profile_views/{viewId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // ‚ù§Ô∏è LIKES
    // ============================================
    match /likes/{likeId} {
      // Leitura: apenas envolvidos (quem deu ou recebeu)
      allow read: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      
      // Cria√ß√£o: usu√°rio autenticado pode dar like
      allow create: if isAuthenticated() && 
        request.resource.data.fromUserId == request.auth.uid;
      
      // Atualiza√ß√£o: apenas quem deu o like (para marcar matchCreated)
      allow update: if isAuthenticated() && 
        resource.data.fromUserId == request.auth.uid;
      
      // Dele√ß√£o: apenas quem deu o like
      allow delete: if isAuthenticated() && 
        resource.data.fromUserId == request.auth.uid;
    }

    // ============================================
    // üíï MATCHES
    // ============================================
    match /matches/{matchId} {
      // Leitura: apenas participantes do match
      allow read: if isUserInArray(resource.data.users);
      
      // Cria√ß√£o: Cloud Functions apenas (via Admin SDK)
      allow create: if false;
      
      // Atualiza√ß√£o: apenas participantes
      allow update: if isUserInArray(resource.data.users);
      
      // Dele√ß√£o: n√£o permitido (usar unmatch que desativa)
      allow delete: if false;
    }

    // ============================================
    // üí¨ CHATS
    // ============================================
    match /chats/{chatId} {
      // Leitura: usu√°rio autenticado que √© participante
      // Nota: permite leitura se o usu√°rio est√° nos participantes do documento
      allow read: if isAuthenticated() && 
        (resource == null || request.auth.uid in resource.data.participants);
      
      // Cria√ß√£o: participante autenticado
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participants;
      
      // Atualiza√ß√£o: apenas participantes
      allow update: if isParticipant(resource.data.participants);
      
      // Dele√ß√£o: n√£o permitido
      allow delete: if false;
      
      // Subcollection: messages
      match /messages/{messageId} {
        // Leitura: participantes do chat pai
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Cria√ß√£o: participante pode enviar mensagem
        allow create: if isAuthenticated() && 
          request.resource.data.senderId == request.auth.uid &&
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Atualiza√ß√£o: apenas remetente (para editar/deletar) ou participante (para marcar lido)
        allow update: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Dele√ß√£o: apenas remetente
        allow delete: if isAuthenticated() && 
          resource.data.senderId == request.auth.uid;
      }
    }

    // ============================================
    // üîî NOTIFICATIONS
    // ============================================
    match /notifications/{notificationId} {
      // Leitura: apenas o destinat√°rio
      allow read: if isOwner(resource.data.userId);
      
      // Cria√ß√£o: Cloud Functions apenas
      allow create: if false;
      
      // Atualiza√ß√£o: apenas o destinat√°rio (para marcar como lido)
      allow update: if isOwner(resource.data.userId);
      
      // Dele√ß√£o: apenas o destinat√°rio
      allow delete: if isOwner(resource.data.userId);
    }

    // ============================================
    // üí≥ PAYMENTS
    // ============================================
    match /payments/{paymentId} {
      // Leitura: apenas o usu√°rio que fez o pagamento ou admin
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // Cria√ß√£o: usu√°rio autenticado pode criar seu pr√≥prio pagamento
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Atualiza√ß√£o: pr√≥prio usu√°rio (para adicionar subscriptionId) ou admin
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // Dele√ß√£o: n√£o permitido
      allow delete: if false;
    }

    // ============================================
    // üíé SUBSCRIPTIONS (Assinaturas Premium/Network)
    // ============================================
    match /subscriptions/{subscriptionId} {
      // Leitura: apenas o dono da assinatura
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Cria√ß√£o: usu√°rio autenticado pode criar sua pr√≥pria assinatura
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Atualiza√ß√£o: apenas o dono (para cancelar, etc)
      allow update: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      
      // Dele√ß√£o: n√£o permitido (manter hist√≥rico)
      allow delete: if false;
    }

    // ============================================
    // üåæ NETWORK CONNECTIONS
    // ============================================
    match /network_connections/{connectionId} {
      // Leitura: apenas envolvidos
      allow read: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      
      // Cria√ß√£o: usu√°rio autenticado
      allow create: if isAuthenticated() && 
        request.resource.data.fromUserId == request.auth.uid;
      
      // Atualiza√ß√£o: apenas envolvidos
      allow update: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      
      // Dele√ß√£o: apenas quem criou
      allow delete: if isAuthenticated() && 
        resource.data.fromUserId == request.auth.uid;
    }

    // ============================================
    // üìß EMAIL VERIFICATIONS
    // ============================================
    match /email_verifications/{verificationId} {
      // Acesso total via Cloud Functions (Admin SDK)
      // Usu√°rios n√£o t√™m acesso direto
      allow read, write: if false;
    }

    // ============================================
    // üéâ EVENTS
    // ============================================
    match /events/{eventId} {
      // Leitura: qualquer usu√°rio autenticado
      allow read: if isAuthenticated();
      
      // Cria√ß√£o: usu√°rio autenticado (produtor)
      allow create: if isAuthenticated() && 
        request.resource.data.producerId == request.auth.uid;
      
      // Atualiza√ß√£o: apenas criador do evento
      allow update: if isAuthenticated() && 
        resource.data.producerId == request.auth.uid;
      
      // Dele√ß√£o: apenas criador do evento
      allow delete: if isAuthenticated() && 
        resource.data.producerId == request.auth.uid;
    }

    // ============================================
    // üí≥ PAYMENTS_EVENT (Pagamentos de Eventos)
    // ============================================
    match /payments_event/{paymentId} {
      // Leitura: apenas o produtor do pagamento
      allow read: if isAuthenticated() && 
        resource.data.producerId == request.auth.uid;
      
      // Cria√ß√£o: usu√°rio autenticado (produtor)
      allow create: if isAuthenticated() && 
        request.resource.data.producerId == request.auth.uid;
      
      // Atualiza√ß√£o: n√£o permitido (pagamentos s√£o imut√°veis)
      allow update: if false;
      
      // Dele√ß√£o: n√£o permitido
      allow delete: if false;
    }

    // ============================================
    // üö´ PASSES (Rejei√ß√µes tempor√°rias)
    // ============================================
    match /passes/{passId} {
      // Leitura: apenas quem deu o pass
      allow read: if isAuthenticated() && 
        resource.data.fromUserId == request.auth.uid;
      
      // Cria√ß√£o: usu√°rio autenticado pode dar pass
      allow create: if isAuthenticated() && 
        request.resource.data.fromUserId == request.auth.uid;
      
      // Atualiza√ß√£o: n√£o permitido (passes s√£o imut√°veis)
      allow update: if false;
      
      // Dele√ß√£o: apenas quem deu o pass (para poder rever usu√°rio)
      allow delete: if isAuthenticated() && 
        resource.data.fromUserId == request.auth.uid;
    }

    // ============================================
    // üìÆ CORREIO DA RO√áA
    // ============================================
    match /correio_da_roca/{correioId} {
      // Leitura: remetente ou destinat√°rio
      allow read: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      
      // Cria√ß√£o: usu√°rio autenticado pode enviar (premium feature)
      allow create: if isAuthenticated() && 
        request.resource.data.fromUserId == request.auth.uid &&
        request.resource.data.status == 'pending';
      
      // Atualiza√ß√£o: apenas destinat√°rio pode responder (aceitar/rejeitar)
      allow update: if isAuthenticated() && 
        resource.data.toUserId == request.auth.uid &&
        resource.data.status == 'pending';
      
      // Dele√ß√£o: n√£o permitido (manter hist√≥rico)
      allow delete: if false;
    }

    // ============================================
    // üõí ITENS_AVULSO (Itens da Loja)
    // ============================================
    match /itens_avulso/{itemId} {
      // Leitura: qualquer usu√°rio autenticado pode ler (itens da loja s√£o p√∫blicos)
      allow read: if isAuthenticated();
      
      // Cria√ß√£o: apenas admins
      allow create: if isAdmin();
      
      // Atualiza√ß√£o: apenas admins
      allow update: if isAdmin();
      
      // Dele√ß√£o: apenas admins
      allow delete: if isAdmin();
    }

    // ============================================
    // üìã PLANS (Planos de Assinatura)
    // ============================================
    match /plans/{planId} {
      // Leitura: qualquer usu√°rio autenticado pode ver os planos
      allow read: if isAuthenticated();
      
      // Cria√ß√£o: apenas admins
      allow create: if isAdmin();
      
      // Atualiza√ß√£o: admins podem atualizar tudo
      // Usu√°rios autenticados podem apenas incrementar totalSubscribers
      allow update: if isAdmin() || 
        (isAuthenticated() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['totalSubscribers']));
      
      // Dele√ß√£o: apenas admins
      allow delete: if isAdmin();
    }

    // ============================================
    // üõçÔ∏è PURCHASES (Compras de Itens Avulsos)
    // ============================================
    match /purchases/{purchaseId} {
      // Leitura: usu√°rio que fez a compra ou admin
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // Cria√ß√£o: usu√°rio autenticado pode criar sua pr√≥pria compra
      // (normalmente via Cloud Functions ap√≥s processamento de pagamento)
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Atualiza√ß√£o: n√£o permitido (compras s√£o imut√°veis)
      allow update: if false;
      
      // Dele√ß√£o: n√£o permitido (manter hist√≥rico)
      allow delete: if false;
    }

    // ============================================
    // üìù USER_SUBSCRIPTIONS (Assinaturas de Planos do Usu√°rio)
    // ============================================
    match /user_subscriptions/{subscriptionId} {
      // Leitura: usu√°rio que possui a assinatura ou admin
      allow read: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // Cria√ß√£o: usu√°rio autenticado pode criar sua pr√≥pria assinatura
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
      
      // Atualiza√ß√£o: usu√°rio pode atualizar (cancelar, etc) ou admin
      allow update: if isAuthenticated() && 
        (resource.data.userId == request.auth.uid || isAdmin());
      
      // Dele√ß√£o: n√£o permitido (manter hist√≥rico)
      allow delete: if false;
    }

    // ============================================
    // üéí USER_INVENTORY (Invent√°rio de Itens do Usu√°rio)
    // ============================================
    match /user_inventory/{userId} {
      // Leitura: apenas o dono do invent√°rio ou admin
      allow read: if isOwner(userId) || isAdmin();
      
      // Cria√ß√£o: apenas o pr√≥prio usu√°rio
      allow create: if isOwner(userId);
      
      // Atualiza√ß√£o: o pr√≥prio usu√°rio (para usar itens) ou admin
      allow update: if isOwner(userId) || isAdmin();
      
      // Dele√ß√£o: n√£o permitido
      allow delete: if false;
    }
  }
}
